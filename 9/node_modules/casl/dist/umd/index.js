!function(n,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(n.casl={})}(this,function(n){"use strict";function t(n,t){for(var e={},r={},i=0;i<n.length;i++){var o=n[i],u=o.inverted?"$and":"$or";if(o.conditions)r.hasOwnProperty(u)||(e[u]=e[u]||[],e[u].push(t(o)));else{if(o.inverted)return null;e[u]&&delete e[u],r[u]=!0}}return n.length>0?e:null}function e(n){return n.inverted?{$nor:[n.conditions]}:n.conditions}function r(n){return n.exec=function(){return Promise.resolve("findOne"===n.op?null:[])},n}function i(n){return t(n,e)}function o(n){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"read",e=i(n.rulesFor(t,this.modelName||this.model.modelName));return null===e?r(this.find()):this.find(e)}function u(n){Error.call(this),this.message=n,this.constructor=u,"function"==typeof Error.captureStackTrace?(this.name=this.constructor.name,Error.captureStackTrace(this,this.constructor)):this.stack=new Error(this.message).stack}function c(n){if(!n||"string"==typeof n)return n;var t="object"===(void 0===n?"undefined":l(n))?n.constructor:n;return t.modelName||t.name}function a(n){return JSON.parse(JSON.stringify(n))}function f(n){return"string"==typeof n||Array.isArray(n)&&n.length>0}u.prototype=Object.create(Error.prototype);var s=function(n){return n&&n.__esModule?n.default:n}(function(n,t){return t={exports:{}},n(t,t.exports),t.exports}(function(n,t){!function(){function e(n){return"function"==typeof n}function r(n){return"[object Array]"===Object.prototype.toString.call(n)}function i(n){return n instanceof Date?n.getTime():r(n)?n.map(i):n&&"function"==typeof n.toJSON?n.toJSON():n}function o(n,t){return e(n.get)?n.get(t):n[t]}function u(n){return function(t,e){if(!r(e)||!e.length)return n(t,e);for(var i=0,u=e.length;i<u;i++)if(n(t,o(e,i)))return!0;return!1}}function c(n,t,e,r){return n.v(n.a,t,e,r)}function a(n,t){for(var e=0;e<n.length;e++){o(n,e);if(c(t,o(n,e)))return e}return-1}function f(n,t){return{a:n,v:t}}function s(n,t){var e=[];if(l(t,n.k,0,t,e),1===e.length){var r=e[0];return c(n.nv,r[0],r[1],r[2])}for(var i=0;i<e.length;i++){var o=e[i];if(c(n.nv,o[0],o[1],o[2]))return!0}return!1}function l(n,t,e,i,u){if(e!==t.length&&void 0!=n){var c=o(t,e);if(r(n)&&isNaN(Number(c)))for(var a=0,f=n.length;a<f;a++)l(o(n,a),t,e,n,u);else l(o(n,c),t,e+1,n,u)}else u.push([n,t[e-1],i])}function h(n,t){return{a:{k:n,nv:t},v:s}}function d(n){return n&&n.constructor===Object}function y(n){(n=i(n))&&d(n)||(n={$eq:n});var t=[];for(var e in n){var r=n[e];if("$options"!==e)if(b[e])g[e]&&(r=g[e](r,n)),t.push(f(i(r),b[e]));else{if(36===e.charCodeAt(0))throw new Error("Unknown operation "+e);t.push(h(e.split("."),y(r)))}}return 1===t.length?t[0]:f(t,b.$and)}function p(n,t){var e=y(n);return t&&(e={a:e,v:function(n,e,r,i){return c(n,t(e),r,i)}}),e}function v(n,t,r){function i(n,t,e){return c(o,n,t,e)}e(t)&&(r=t,t=void 0);var o=p(n,r);return t?t.filter(i):i}var b={$eq:u(function(n,t){return n(t)}),$ne:function(n){return function(t,e){if(!r(e)||!e.length)return n(t,e);for(var i=0,u=e.length;i<u;i++)if(!n(t,o(e,i)))return!1;return!0}}(function(n,t){return!n(t)}),$gt:u(function(n,t){return v.compare(i(t),n)>0}),$gte:u(function(n,t){return v.compare(i(t),n)>=0}),$lt:u(function(n,t){return v.compare(i(t),n)<0}),$lte:u(function(n,t){return v.compare(i(t),n)<=0}),$mod:u(function(n,t){return t%n[0]==n[1]}),$in:function(n,t){if(!(t instanceof Array)){var e=i(t);if(e===t&&"object"==typeof t)for(u=n.length;u--;)if(String(n[u])===String(t)&&"[object Object]"!==String(t))return!0;if(void 0===e)for(u=n.length;u--;)if(null==n[u])return!0;for(u=n.length;u--;){var r=c(p(o(n,u),void 0),t,u,n);if(r&&"[object Object]"!==String(r)&&"[object Object]"!==String(t))return!0}return!!~n.indexOf(e)}for(var u=t.length;u--;)if(~n.indexOf(i(o(t,u))))return!0;return!1},$nin:function(n,t,e,r){return!b.$in(n,t,e,r)},$not:function(n,t,e,r){return!c(n,t,e,r)},$type:function(n,t){return void 0!=t&&(t instanceof n||t.constructor==n)},$all:function(n,t,e,r){return b.$and(n,t,e,r)},$size:function(n,t){return!!t&&n===t.length},$or:function(n,t,e,r){for(var i=0,u=n.length;i<u;i++)if(c(o(n,i),t,e,r))return!0;return!1},$nor:function(n,t,e,r){return!b.$or(n,t,e,r)},$and:function(n,t,e,r){for(var i=0,u=n.length;i<u;i++)if(!c(o(n,i),t,e,r))return!1;return!0},$regex:u(function(n,t){return"string"==typeof t&&n.test(t)}),$where:function(n,t,e,r){return n.call(t,t,e,r)},$elemMatch:function(n,t,e,i){return r(t)?!!~a(t,n):c(n,t,e,i)},$exists:function(n,t,e,r){return r.hasOwnProperty(e)===n}},g={$eq:function(n){return n instanceof RegExp?function(t){return"string"==typeof t&&n.test(t)}:n instanceof Function?n:r(n)&&!n.length?function(n){return r(n)&&!n.length}:null===n?function(n){return null==n}:function(t){return 0===v.compare(i(t),n)}},$ne:function(n){return g.$eq(n)},$and:function(n){return n.map(y)},$all:function(n){return g.$and(n)},$or:function(n){return n.map(y)},$nor:function(n){return n.map(y)},$not:function(n){return y(n)},$regex:function(n,t){return new RegExp(n,t.$options)},$where:function(n){return"string"==typeof n?new Function("obj","return "+n):n},$elemMatch:function(n){return y(n)},$exists:function(n){return!!n}};v.use=function(n){if(e(n))return n(v);for(var t in n)36===t.charCodeAt(0)&&(b[t]=n[t])},v.indexOf=function(n,t,e){return a(t,p(n,e))},v.compare=function(n,t){if(n===t)return 0;if(typeof n==typeof t){if(n>t)return 1;if(n<t)return-1}},Object.defineProperty(t,"__esModule",{value:!0}),n.exports=v,t.default=n.exports.default=v,"undefined"!=typeof window&&(window.sift=v)}()})),l="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(n){return typeof n}:function(n){return n&&"function"==typeof Symbol&&n.constructor===Symbol&&n!==Symbol.prototype?"symbol":typeof n},h=function(n,t){if(!(n instanceof t))throw new TypeError("Cannot call a class as a function")},d=function(){function n(n,t){for(var e=0;e<t.length;e++){var r=t[e];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(n,r.key,r)}}return function(t,e,r){return e&&n(t.prototype,e),r&&n(t,r),t}}(),y=function(){function n(n,t){var e=[],r=!0,i=!1,o=void 0;try{for(var u,c=n[Symbol.iterator]();!(r=(u=c.next()).done)&&(e.push(u.value),!t||e.length!==t);r=!0);}catch(n){i=!0,o=n}finally{try{!r&&c.return&&c.return()}finally{if(i)throw o}}return e}return function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return n(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),p=function(){function n(t){h(this,n),this.conditions=t.conditions,this.actions=t.actions,this.subject=t.subject,this.inverted=!!t.inverted,this._matches=this.conditions?s(this.conditions):null}return d(n,[{key:"matches",value:function(n){return!this._matches||this._matches(n)}}]),n}(),v={manage:["create","read","update","delete"]},b="undefined"!=typeof Symbol?Symbol.for("private"):"__private"+Date.now(),g=function(){function n(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=e.RuleType,i=void 0===r?p:r,o=e.subjectName,u=void 0===o?c:o;h(this,n),this[b]={RuleType:i,subjectName:u,originalRules:t,rules:{},events:{},aliases:a(v)},this.update(t)}return d(n,null,[{key:"addAlias",value:function(n,t){if(n===t||Array.isArray(t)&&-1!==t.indexOf(n))throw new Error("Attempt to alias action to itself: "+n+" -> "+t.toString());return v[n]=t,this}}]),d(n,[{key:"update",value:function(n){return Array.isArray(n)&&(this.emit("update",{rules:n,ability:this}),this[b].originalRules=Object.freeze(n.slice(0)),this[b].rules=this.buildIndexFor(this.rules)),this}},{key:"buildIndexFor",value:function(n){for(var t={},e=this[b].RuleType,r=0;r<n.length;r++)for(var i=n[r],o=this.expandActions(i.actions),u=0;u<o.length;u++)for(var c=o[u],a=Array.isArray(i.subject)?i.subject:[i.subject],f=0;f<a.length;f++){var s=a[f];t[s]=t[s]||{},t[s][c]=t[s][c]||[],t[s][c].unshift(new e(i))}return t}},{key:"expandActions",value:function(n){var t=this,e=Array.isArray(n)?n:[n],r=this[b].aliases;return e.reduce(function(n,e){return r.hasOwnProperty(e)?n.concat(t.expandActions(r[e])):n},e)}},{key:"can",value:function(n,t){var e=this[b].subjectName(t),r=this.rulesFor(n,t);if(t===e)return r.length>0&&!r[0].inverted;for(var i=0;i<r.length;i++)if(r[i].matches(t))return!r[i].inverted;return!1}},{key:"rulesFor",value:function(n,t){var e=this[b].subjectName(t),r=this[b].rules,i=r.hasOwnProperty(e)?r[e][n]:null;return((r.hasOwnProperty("all")?r.all[n]:null)||[]).concat(i||[])}},{key:"cannot",value:function(n,t){return!this.can(n,t)}},{key:"throwUnlessCan",value:function(n,t){if(this.cannot(n,t))throw new u('Cannot execute "'+n+'" on "'+this[b].subjectName(t)+'"')}},{key:"on",value:function(n,t){var e=this[b].events,r=!0;return e[n]||(e[n]=[]),e[n].push(t),function(){if(r){r=!1;var i=e[n].indexOf(t);e[n].splice(i,1)}}}},{key:"emit",value:function(n,t){var e=this[b].events[n];e&&e.forEach(function(n){return n(t)})}},{key:"rules",get:function(){return this[b].originalRules}}]),n}(),m=function(){function n(){h(this,n),this.rules=[]}return d(n,null,[{key:"define",value:function(n,t){var e=y("function"==typeof n?[{},n]:[n,t],2),r=e[0],i=e[1],o=new this;return i(o.can.bind(o),o.cannot.bind(o)),new g(o.rules,r)}},{key:"extract",value:function(){var n=new this;return{can:n.can.bind(n),cannot:n.cannot.bind(n),get rules(){return n.rules}}}}]),d(n,[{key:"can",value:function(n,t,e){if(!f(n))throw new TypeError("AbilityBuilder#can expects the first parameter to be an action or array of actions");if(!f(t))throw new TypeError("AbilityBuilder#can expects the second argument to be a subject name or array of subject names");var r={actions:n,subject:t};return"object"===(void 0===e?"undefined":l(e))&&e&&(r.conditions=e),this.rules.push(r),r}},{key:"cannot",value:function(){var n=this.can.apply(this,arguments);return n.inverted=!0,n}}]),n}();n.toMongoQuery=i,n.mongoosePlugin=function(n){return n.query.accessibleBy=o,n.statics.accessibleBy=o,n},n.rulesToQuery=t,n.Ability=g,n.Rule=p,n.AbilityBuilder=m,n.ForbiddenError=u,Object.defineProperty(n,"__esModule",{value:!0})});
